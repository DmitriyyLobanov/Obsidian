 2024-08-16 15:15

***
Материал из источника (https://habr.com/ru/companies/sberbank/articles/836092/)

**BPMN** — это нотация (или метод, хотя почти везде пишут «система») моделирования или описания бизнес-процессов. Бизнес-процесс представляет из себя логику (алгоритм) работы системы для достижения поставленной задачи. Соответственно, BPMN-диаграмма — это диаграмма, которая описывает бизнес-процесс.

**BPMN** подразумевает выполнение диаграмм на различных уровнях абстракции:
- **[[Описательный]]** (управленческий, согласовательный, descriptive) - используется для верхнеуровневых моделей, которые нужны описания процесса для руководителей. Часто описывает только happy path. Должен быть понятен человеку без глубоких знаний BPMN.
- **[[Аналитический]]** уровень отражает подробности исполнения, которые нужны для анализа и оптимизации процессов. Для него требуется уверенное владение нотацией.
- **[[Исполняемый]]** (execute) - используется в системах управления бизнес-процессами.

>Понятие токена:
>Токен в моделировании бизнес-процессов - это концепция, нужная для понимания работы процесса. Токен используется чтобы описать отдельный экземпляр запуска процесса.
>(Изображается простым закрашенным кругом, перемещается по потоку.)

| **Процесс**                                                                             | **Токен процесса**                                              |
| --------------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| Процесс продажи маркированной продукции в розничном магазине                            | Продажа одного заказа с маркированной продукцией                |
| Процесс согласования приказов в компании                                                | Согласование одного приказа                                     |
| Процесс проведения оценки стоимости активов для получателей кредитов для малого бизнеса | Проведение одной оценки стоимости активов для получения кредита |

>ВАЖНО!
>Процесс считается завершенным только тогда, когда все токены достигли завершающих событий.

Основные элементы из которых состоит BPMN диаграмма:
- **События**
- **Действия**
- **Шлюзы**
- **Потоки**
![[Pasted image 20240816152058.png]]
		события (синий), действия (зелёный), шлюзы (красный) и потоки (желтый)

Элементов на самом деле элементов больше, но без основных не обойтись, их и на собеседованиях спрашивают.

### События

**События** (триггеры) используются для того, чтобы отобразить какое-то происшествие, например, приход сообщения в топик. События могут быть стартовыми, завершающими или промежуточными. Стартовые обозначают начало процесса, завершающие — его окончание, а промежуточные события могут приостанавливать выполнение процесса.

Обычно _стартовые_ события имеют тонкую рамку, _промежуточные_ — двойную, а _завершающие_ жирную рамку:

![[Pasted image 20240816154150.png]]
						Основные типы событий

>В BPMN 2.0 есть другие события, но для базы хватит этих

Помимо разделения на три основных типа, ещё есть разделение на типы по характеру работы события. Самые востребованные:
![[Pasted image 20240816154314.png]]
				Основные типы событий по характеру работы.

- **Пустое**. 
  Используется для описания подпроцесса.
- **Сообщение**.
  Используется в тех случаях, когда, например, инициатором запуска процесса выступает новое сообщение в топике, либо запрос.
- **Таймер**.
  Почти все сценарии, связанные со временем. Например запуск процесса в 12.00 каждый день.
- Ошибка.
  Событие, которое чаще всего используют как завершающее для негативных сценариев.

Так же момент чуть посложнее, события могут быть прерывающими и не прерывающими.
К примеру, к activity (действию), может быть прикреплено событие, и в случае если оно прерывающее - оно прекратит процесс, если не прерывающее, то токен не уничтожается, а пропускается дальше по процессу, но событие генерирует ещё один и пускает по ответвлению события (при чем, генерируется столько токенов, сколько раз событие сработало, на примере таймера очень наглядно)

![[Pasted image 20241114113259.png]]

#### "Сложные события" (расширенное описание)

![[Pasted image 20241114204329.png]]

##### Сообщения
Сообщения служат для межпроцессного взаимодействия, соответственно есть событие "получение сообщения" и "отправка сообщения", если для процесса, получающего сообщение оно не является стартовым событием - необходимо продумать момент и тем, что отправитель должен знать конкретного получателя. 
![[Pasted image 20241114160923.png]]

##### Таймер
Таймеры бывают стартовыми и промежуточными, завершающих таймеров не бывает. Всё с ними в принципе понятно.

##### Ошибки
Редко используемый элемент.
Индикатор ошибки в процессе - логично блеать!
![[Pasted image 20241114161932.png]]
Тот же самый процесс можно обрисовать с помощью шлюза. Событие "ошибка" здесь просто для дополнительной наглядности.
##### Эскалация

Событие похожее на ошибку, используется как и ошибка для ссылки на другой процесс, как пример использования - "Отправка СМС клиенту с извинением за просрочку заказа"
![[Pasted image 20241114162944.png]]

##### Компенсация
![[Pasted image 20241114163124.png]]

![[Pasted image 20241114163351.png]]
Прикрепленное событие компенсации прикрепляется к специальной conpensation activity и связь у них ассоциация, странно но факт.
Теоретически можно расписать с помощью шлюзов, но так нагляднее и минималистичнее.

С технической точки зрения это те самые ROLLBACK, SAGA и прочие распределённые транзакции.

##### Отмена

Работает только вместе с транзакционным подпроцессом (подпроцесс внутри основного, имеющий компенсации)
И он как бы "атомарный", либо он выполняет абсолютно всю логику успешно, либо откатывает все изменения в случае неудачи на каком то из шагов.
![[Pasted image 20241114164622.png]]
То есть, если в этом подпроцессе токен достигнет отмены, автоматически сработают все компенсации.

Так же можно на транзакционный подпроцесс повесить промежуточную отмену, и если сработает основная внутри, промежуточная сделает наружу какую то отбивку.
![[Pasted image 20241114164900.png]]

##### По условию
![[Pasted image 20241114165045.png]]
Стартовые и промежуточные.
![[Pasted image 20241114165243.png]]
Срабатывает на уровне контекста (данных), как на примере: если при звонке клиента выясняется, что переменная VIP = true, то запускается подпроцесс "Обработать как випа"

##### Ссылка Link

Ссылка работает как "телепорт", разрывая поток управления, события стоит красить в один цвет, и не увлекаться ими потому что страдает читаемость логики.

![[Pasted image 20241114203222.png]]
![[Pasted image 20241114203239.png]]

##### Сигнал
![[Pasted image 20241114203309.png]]
В отличии от message сигнал не должен знать своего адресата

>Пример на пальцах:
>Message: Приходит почтальон и говорит "На Дима твоё письмо"
>Signal: Приходит почтальон и кричит "Почта пришла!"

Сигнал - самый редкий символ в BPMN!
На сигналы подписывают процессы как консумеры подписываются на топики kafka.
##### Встроенный подпроцесс обработчик по событию

Подпроцесс, связанный с внешним миром, не связанный потоками управления с конкретными элементами основного процесса. Используется когда непонятно в какой конкретно момент времени произойдёт событие, например, когда непонятно в каком конкретно месте клиент может отказаться. Подпроцесс может начинаться с непрерывающего стартового события и не прекращать основной поток, так и прерывающего, при срабатывании которого происходит остановка основного потока.

Так же подпроцесс обработчик может стартовать по событию "ошибка" сработавшем в основном процессе.

![[Pasted image 20241114135524.png]]


### Действия

Действия (или задачи) используются для отображения функций, которые будут выполняться программой. Также как и события, бывают нескольких типов и разные по характеру. Но практика показывает, что нет смысла перегружать схему большим количеством действий разных типов, это сильно усложняет схему для понимания (далеко не все глубоко разбираются в нотации). Поэтому обычно используется только две разновидности:

- **Обычное действие.**
  Действие используется для описания активности, которую уже нельзя декомпозировать. Ну в идеале.
- **Подпроцесс**.
  Это действие используется, когда необходимо в описываемый процесс внедрить ещё один (например описанный отдельно)

![[Pasted image 20240816170155.png]]
							Основные типы действий

![[Pasted image 20241021124548.png]]
![[Pasted image 20241021124703.png]]
![[Pasted image 20241021124945.png]]
![[Pasted image 20241021125120.png]]


### Шлюзы

Шлюзы - это элементы, которые используются для того чтобы ввести в процесс ветвление, условия, дополнительную логику. Чаще всего используют три типа шлюзов (опять же, в BPMN 2.0 типов больше, но для основной практики хватит трёх):

![[Pasted image 20240816170921.png]]
							Основные типы шлюзов

>**"Исключающее ИЛИ"** - такой шлюз используется для разделения выполнения процесса на один из вариантов. То есть работает как выбор, в процессе выполняется либо одна ветка, либо другая.

Примеры:

![[55daeff0b999ff1219e7c6b3dd69cd89.gif]]
![[пример 2.gif]]

![[Pasted image 20241021121840.png]]
Перечеркнутая стрелка после шлюза означает поток по умолчанию Если нет точного соответствия указанным условиям - выполняется он (устанавливать дефолтный поток необязательно).


>"**И**" - шлюз используется для распараллеливания процесса на две ветки, которые исполняются одновременно.

Примеры:

![[и1.gif]]
![[и2.gif]]
![[Pasted image 20241021122345.png]]

**"Включающее ИЛИ"** - этот шлюз включает в себя функции двух вышеописанных: выполнение процесса может как распараллеливаться на все ветви, так и разбиться на определённые, отвечающие условию.

![[Pasted image 20240816172144.png]]
					Пример с шлюзом "Включающее ИЛИ"

Пример разделения потоков:
![[вклили.gif]]

![[Pasted image 20241021122446.png]]
Так же в статье-источнике есть рекомендации по применению шлюзов.

**"Event based" шлюз.** Появился в BPMN2:

![[Pasted image 20241114111352.png]]

Работает следующим образом:
Даёт развилку на несколько событий, по срабатыванию какого либо - токен проходит по этой ветке, остальные аннулируются. 

Шлюз может быть только разводящей развилкой, собирающую для него ставят "или"
![[Pasted image 20241114111947.png]]



### Потоки

Тут всё очень просто, потоки - это стрелки, которые отображают последовательность действий в процессе.

Поток управления (сплошная стрелка) не используется для отображения взаимодействия между разными процессами. Для этого есть поток сообщений (пунктирная стрелка)
![[Pasted image 20241021115313.png]]

Но поток сообщений не может соединять задачи внутри одного пула

![[Pasted image 20241021115343.png]]

Обычная сплошная стрелка - поток управления.
Так же существует **ассоциация**
![[Pasted image 20241021115634.png]]
Ассоциация - это элемент, который связывает артефакты с элементами BPMN. Она лишь показывает смысловую связь, но никак не влияет на работу процесса.
### Дорожки

Теоретически, это необязательный элемент, но на практике используется настолько часто, что многие считают его неотъемлемой частью любой схемы.
Дорожка представляет собой подписанный прямоугольник, внутри которого находятся элементы, которые выполняются на стороне сущности, указанной в заголовке дорожки.

![[Pasted image 20240817222901.png]]
							Пример с дорожками

![[Pasted image 20241021140147.png]]
![[Pasted image 20241021140338.png]]

### Артефакты

Артефакты - это набор элементов, которые не влияют на исполнение процесса, но дополняют диаграмму информацией. Артефакт не может быть ни целью, ни источником потока управления или потока сообщений. Связь элемента с артефактом выполняется с помощью ассоциации.
![[Pasted image 20241021141003.png]]
![[Pasted image 20241021141109.png]]
![[Pasted image 20241021141246.png]]


### Примечание

В статье есть классный пример с последовательным усложнением схемы от примитивной к подробной.
***
Видос по проверке диаграмм: https://www.youtube.com/watch?v=oPx5SD-Gx0I





### Теги
[[Моделирование требований]]
#Learn